# Backend API для компонентов ПК

FastAPI приложение для управления данными о компонентах ПК (CPU, GPU, RAM, Storage, Cooling).

## Особенности

- **Автоматический парсинг данных** при запуске приложения
- **Автоматическое обновление** данных раз в полгода (180 дней)
- **Headless режим** для работы на VPS
- **Асинхронная работа** с базой данных SQLite
- **RESTful API** для доступа к данным

## Установка

### 1. Установка зависимостей

```bash
cd backend
pip install -r requirements.txt
```

### 2. Установка браузера для парсинга

Для работы парсера требуется Chrome/Chromium. 

**На Windows (локальная разработка):**
- Установите Chrome или используйте существующий
- DrissionPage найдет его автоматически

**На VPS (Linux):**
```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y chromium-browser chromium-chromedriver

# Или через npx (если установлен Node.js)
npx @puppeteer/browsers install chrome@stable
```

## Настройка

### Переменные окружения

- `SKIP_PARSING` - пропустить парсинг при запуске (по умолчанию: `false`)
  - Установите `SKIP_PARSING=true` чтобы пропустить парсинг
- `HEADLESS` - запуск браузера в headless режиме (по умолчанию: `true`)
  - Установите `HEADLESS=false` для отладки (покажет браузер при парсинге)

### Пример настройки

```bash
# Для локальной разработки (с видимым браузером)
export HEADLESS=false

# Для VPS (headless режим)
export HEADLESS=true
```

## Запуск

### Локальный запуск (для тестирования)

```bash
cd backend
# С видимым браузером для отладки
export HEADLESS=false
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### Запуск на VPS

```bash
cd backend
uvicorn main:app --host 0.0.0.0 --port 8000
```

## Как это работает

1. **При запуске приложения:**
   - Создаются таблицы БД (если их нет)
   - Проверяется дата последнего обновления данных
   - Если прошло больше 6 месяцев (180 дней) или данных нет - запускается парсинг
   - Парсинг данных с сайтов:
     - CPU: https://www.techpowerup.com/cpu-specs/
     - GPU: https://www.techpowerup.com/gpu-specs/
     - PSU: https://www.cybenetics.com/index.php?option=psu-performance-database
   - Данные загружаются в базу данных
   - Сохраняется дата последнего обновления

2. **Автоматическое обновление:**
   - При каждом запуске проверяется, прошло ли 6 месяцев с последнего обновления
   - Если прошло - выполняется автоматический парсинг и обновление данных
   - Если нет - парсинг пропускается, используются существующие данные

3. **После парсинга:**
   - API готов к работе
   - Можно делать запросы к эндпоинтам для получения данных

## API Endpoints

### Основные эндпоинты

- `GET /` - информация о API
- `GET /health` - проверка здоровья приложения
- `GET /parsing/status` - статус парсинга (дата последнего обновления, нужно ли обновление)

### Компоненты

- `GET /cpus` - список всех CPU
- `GET /cpus/{cpu_name}` - поиск CPU по имени
- `GET /gpus` - список всех GPU
- `GET /gpus/{gpu_name}` - поиск GPU по имени
- `GET /ram` - список всех RAM
- `GET /storages` - список всех накопителей
- `GET /cooling` - список всех систем охлаждения

## Структура проекта

```
backend/
├── main.py              # Точка входа FastAPI приложения
├── database/
│   ├── __init__.py     # Экспорт модулей БД
│   ├── database.py     # Настройка БД и сессий
│   └── models.py       # Модели SQLAlchemy
├── routers/             # API роутеры
│   ├── cpus.py
│   ├── gpus.py
│   ├── ram.py
│   ├── storages.py
│   ├── cooling.py
│   └── system.py
├── schemas/             # Pydantic схемы
│   └── schemas.py
└── parsing/             # Модуль парсинга
    ├── __init__.py
    ├── parser.py        # Основной парсер
    └── update_tracker.py # Отслеживание обновлений
```

## Файлы данных

- `components.db` - база данных SQLite с компонентами
- `.last_update.json` - файл с датой последнего обновления (автоматически создается)

## Примечания

- Парсинг может занять некоторое время при первом запуске (несколько минут)
- Если парсинг не удался, приложение все равно запустится с существующими данными
- Для принудительного обновления можно удалить файл `.last_update.json` или установить `SKIP_PARSING=false`
- Данные обновляются автоматически раз в полгода при запуске приложения

## Troubleshooting

### Проблемы с браузером

Если браузер не найден:
- На Windows: убедитесь что Chrome установлен
- На Linux: установите chromium-browser
- Попробуйте запустить с `HEADLESS=false` для отладки

### Проблемы с парсингом

- Проверьте логи приложения
- Убедитесь что сайты доступны
- Попробуйте запустить с `HEADLESS=false` для отладки
- Проверьте интернет-соединение

### Принудительное обновление данных

```bash
# Удалить файл отслеживания обновлений
rm backend/.last_update.json

# Перезапустить приложение
uvicorn main:app --reload
```
